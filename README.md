## 前庭功能检查报告系统（Vestibular Function Report System）

一款基于 Tkinter 的前庭功能检查报告生成与数据管理工具。支持多项检查页面的数据录入与管理，统一保存到本地数据库目录（按日期分层），并对配置文件进行对称加密存储（Fernet）。

---

### 功能特性
- **多检查页面一体化**：包含基本信息、眼震/头脉冲/视动/温度试验、VEMP、SVV、检查结论等页面，侧边栏一键切换。
- **数据完整性校验**：保存时强制检查基本信息的必填字段（`ID`、`姓名`、`性别`、`检查时间`、`检查医生`、`检查设备`）。
- **数据库路径可配置**：默认在项目下创建 `vest_database`，可在菜单中更改数据库目录并自动重启生效。
- **多媒体统一归档**：保存时将图片/视频复制到数据库内按日期归档，并根据检查类型+时间戳重命名；报告 JSON 内记录相对路径。
- **配置加密**：`config.json` 使用激活码派生的密钥进行 Fernet 加密，包含密码、数据库路径与字体设置。
- **字体注册**：自动注册中文字体（默认 `SimSun`，文件为项目根目录下 `SIMSUN.ttf`）。

---

### 环境要求
- Python 3.8+（建议 3.10 或更高）
- macOS / Windows / Linux（已内置不同平台下“打开文件夹”的兼容处理）

依赖请直接通过 `requirements.txt` 安装。

```bash
pip install -r requirements.txt
```

常见核心依赖（供参考）：`reportlab`、`cryptography`（Tkinter 为标准库）。

---

### 快速开始
1) 克隆或下载本项目到本地。
2) 安装依赖：
```bash
pip install -r requirements.txt
```
3) 运行：
```bash
python main.py
```

首次启动会进入激活与密码设置流程（见下文）。

---

### 首次启动与激活流程
程序启动顺序（参考 `main.py`）：
1. 检查是否已激活（是否能成功解密 `config.json`）。
2. 若未激活，弹出激活窗口，输入激活码完成激活：
   - 默认激活码：`524865`
3. 激活成功后，立即设置系统密码（用于后续每次启动的登录验证）。
4. 之后每次启动会先要求输入系统密码。

提示：若忘记密码，可删除项目根目录下的 `config.json` 后重新启动进行重新激活与设置（会丢失之前的配置项，如自定义数据库路径与字体设置）。

---

### 配置与字体
- 配置文件：项目根目录 `config.json`（加密存储）。
- 配置项：`password`、`db_path`、`font_name`、`font_path`。
- 字体：默认 `SimSun`，要求项目根目录存在 `SIMSUN.ttf`；若加载失败将尝试使用默认字体并提示。

---

### 数据库存储结构与保存规则
数据库根目录默认：`<项目路径>/vest_database`，可在菜单中“数据库 → 更改数据库文件夹”修改（修改后程序会自动重启生效）。程序运行时会按当天日期创建子目录：
- `report/YYYY-MM-DD/`：报告 JSON 文件。
- `pic/YYYY-MM-DD/`：图片。
- `video/YYYY-MM-DD/`：视频。
- `HIS/YYYY-MM-DD/`：预留 HIS 相关文件夹。

保存时的命名与复制逻辑（见 `save_data()`、`process_image()`、`process_video()`）：
- 报告 JSON：`{ID}_{yyyyMMdd_HHmmss}.json` 保存到 `report/YYYY-MM-DD/`。
- 图片：对特定检查（如“头脉冲试验”“头脉冲抑制试验”“温度试验”）的图像，复制到 `pic/YYYY-MM-DD/`，重命名为 `{english_test_name}_{yyyyMMdd_HHmmss}{原扩展名}`。
- 视频：对支持视频的检查（如 Dix-Hallpike、仰卧滚转、自发/凝视性眼震、摇头、瘘管、视动性眼震），复制到 `video/YYYY-MM-DD/`，重命名规则同上。
- 报告 JSON 内记录上述多媒体的**相对路径**（相对于数据库根目录）。

必填字段校验（保存前）：`ID`、`姓名`、`性别`、`检查时间`、`检查医生`、`检查设备` 未填写将阻止保存并提示。

---

### 程序主要结构（节选）
- `main.py`：主程序入口，菜单、页面路由、配置与激活、数据保存、多媒体复制、打开/更改数据库目录等。
- `*_page.py`：各检查页面的 UI 与数据收集逻辑（`get_data()` 汇总到保存流程）。
- `template/`：Excel 报告模板（如后续导出使用）。
- `vest_database/`：样例与归档数据根目录。

示例侧边栏页面（`main.py#create_sidebar`）：基本信息、自发/凝视性眼震、头脉冲/抑制、反向偏斜、扫视、视觉增强 VOR、VOR 抑制、摇头、Dix‑Hallpike、仰卧滚转、其他位置试验、视跟踪、视动性眼震、瘘管、温度试验、cVEMP、oVEMP、SVV、检查结论。

---

### 常见操作
- 新建报告：菜单“文件 → 新建”。会清空所有页面输入，其中对头脉冲试验的 PR 分数字段重置为 "NA"。
- 保存报告：菜单“文件 → 保存”。自动进行必填校验与多媒体复制归档。
- 查看数据库：菜单“数据库 → 查看数据库”。
- 更改数据库位置：菜单“数据库 → 更改数据库文件夹”（保存后程序将自动重启）。
- 打开数据库文件夹：菜单“数据库 → 打开数据库文件夹”。
- 关于：菜单“帮助 → 关于”。

---

### 故障排查
- 无法激活或提示配置损坏：删除 `config.json` 后重启，再按“首次启动与激活流程”操作。
- 字体加载失败：确认项目根目录有 `SIMSUN.ttf`，或在首次设置时提供正确的字体路径。
- 无法保存：检查必填字段是否完整，多媒体原文件路径是否存在且可读。

    